<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Peak Map</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<script src="https://api.mapbox.com/mapbox.js/v3.0.1/mapbox.js"></script>
<link href="https://api.mapbox.com/mapbox.js/v3.0.1/mapbox.css" rel="stylesheet">
<link href="tooltip.css" rel="stylesheet">
<script src="tooltip.js"></script>
<style>
body {margin: 0; padding: 0;}
#map {position: absolute; top: 0; bottom: 0; width: 100%;}
a {text-decoration: none;}
.popupDiv {
	font-family: verdana;
	font-size: 10pt;
	white-space: nowrap;
}
.popupDiv b a {
	font-weight: bold;
}
.blmPopup {
	text-align: center;
}
.elevDiv {display: inline-block; vertical-align: top;}
#llDiv {
	position: absolute;
	bottom: 40px;
	right: 10px;
	font-family: verdana;
	font-size: 10pt;
}
#llText {
	background-color: rgba(255,255,255,0.8);
	border-radius: 5px;
	padding: 3px 5px;
}
#fitLink {
	background-color: rgba(255,255,255,0.8);
	border: 1px solid rgb(128,128,128);
	border-radius: 5px;
	padding: 3px 5px;
}
#fitLink:hover {
	background-color: rgba(236,236,236,0.8);
	cursor: pointer;
}
.peakIcon {}
.centerIcon {}
</style>
<script>
"use strict";

var BLM_CA_NLCS_Prefix = 'https://www.blm.gov/nlcs_web/sites/ca/st/en/prog/nlcs/';
var Wikipedia_Prefix = 'https://en.wikipedia.org/wiki/';

function isValidId(s)
{
	return s.length <= 16 && s.match(/^[a-z][_0-9a-z]*$/) !== null;
}
function parseLatLng(q, v)
{
	var m = v.match(/^(-?[0-9]{1,3}(?:\.[0-9]{1,8})?),(-?[0-9]{1,3}(?:\.[0-9]{1,8})?)$/);

	if (m === null) return;

	var lat = parseFloat(m[1]);
	if (lat < -90 || lat > 90) return;

	var lng = parseFloat(m[2]);
	if (lng < -180 || lng > 180) return;

	q.ll = [lat, lng];
}
function parseZoom(q, v)
{
	if (v.match(/^[1-9][0-9]?$/) === null) return;

	var zoom = parseInt(v);
	if (zoom < 1 || zoom > 22) return;

	q.zoom = zoom;
}
var validOverlays = {
	blm_ca_aa: 'blm_ca_aa.json',
	blm_ca_fo: 'blm_ca_fo.json',
	blm_ca_sa: 'blm_ca_sa.json',
	dps: 'dps.json',
	sps: 'sps.json',
};
function parseOverlay(q, v)
{
	if (isValidId(v) && validOverlays[v])
	{
		q.overlays.push(validOverlays[v]);
		delete validOverlays[v];
	}
}
var validBaseLayers = {
	o: 'Outdoors',
	rbh: 'Run Bike Hike',
	s: 'Satellite',
	sts: 'Streets Satellite',
	st: 'Streets',
	p: 'Pencil',
	e: 'Emerald',
};
function parseBaseLayer(q, v)
{
	if (isValidId(v) && validBaseLayers[v])
		q.baseLayer = validBaseLayers[v];
}
function parseQueryString(queryString)
{
	var q = window.location.search;

	if (typeof q !== 'string' || q.charAt(0) !== '?') return;

	var handlers = {
		b: parseBaseLayer,
		ll: parseLatLng,
		o: parseOverlay,
		z: parseZoom,
	};

	for (var s of q.substr(1).split('&'))
	{
		var i = s.indexOf('=');
		if (i < 1 || i === s.length - 1) continue;
		var k = s.substr(0, i);
		var v = s.substr(i + 1);

		if (isValidId(k) && handlers[k])
			handlers[k](queryString, v);
	}
}
function makeLink(url, txt)
{
	return '<a href="' + url + '">' + txt + '</a>';
}
function popupHtml(ll, p, htmlFilename)
{
	var g4URL = 'https://mappingsupport.com/p/gmap4.php?ll=' + ll.lat + ',' + ll.lng + '&' + p.G4;

	var suffix = p.HP ? ' HP' : p.emblem ? ' **' : p.mtneer ? ' *' : '';

	var otherName = p.name2 ? '<br>(' + p.name2 + ')' : '';

	var name = makeLink(htmlFilename + p.id.split('.')[0], p.id) + ' '
		+ makeLink(g4URL, p.name) + suffix + otherName;

	var links = [];
	if (p.SP) links.push(makeLink('http://www.summitpost.org/' + p.SP, 'SP'));
	if (p.W) links.push(makeLink('https://en.wikipedia.org/wiki/' + p.W, 'W'));
	if (p.BB) links.push(makeLink('http://www.snwburd.com/dayhikes/peak/' + p.BB, 'BB'));
	if (p.LoJ) links.push(makeLink('http://listsofjohn.com/peak/' + p.LoJ, 'LoJ'));
	if (p.Pb) links.push(makeLink('http://peakbagger.com/peak.aspx?pid=' + p.Pb, 'Pb'));
	if (!p.noWX) links.push(makeLink('http://forecast.weather.gov/MapClick.php?lon='
		+ ll.lng + '&lat=' + ll.lat, 'WX'));

	links = links.length === 0 ? '' : '<br>' + links.join(', ');

	var climbed = p.climbed ? '<br>Climbed ' + p.climbed : '';

	return '<div class="popupDiv"><b>' + name + '</b>'
		+ '<br>Elevation: <div class="elevDiv">' + p.elev + '</div>'
		+ '<br>Prominence: ' + p.prom
		+ '<br>Class ' + p.YDS
		+ links + climbed + '</div>';
}
function peakIcon(p)
{
	var fill = p.emblem ? 'magenta' : p.mtneer ? 'cyan' : 'white';
	var stroke = p.climbed ? 'green' : 'red';

	var o = {iconSize: [20, 26], className: 'peakIcon', popupAnchor: [0, -8]};
	o.html = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="26" viewBox="0 0 20 26">'
		+ '<path fill="' + fill + '" stroke="' + stroke + '" stroke-width="3" '
		+ 'd="M 10,2 L 1,19 19,19 Z" /></svg>';
	return L.divIcon(o);
}
function centerIcon()
{
	var o = {iconSize: [28, 28], className: 'centerIcon'};
	o.html = '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 28 28">'
		+ '<line x1="13" y1="0" x2="13" y2="28" stroke="white" stroke-dasharray="9 10" />'
		+ '<line x1="14" y1="0" x2="14" y2="28" stroke="black" stroke-dasharray="9 10" />'
		+ '<line x1="15" y1="0" x2="15" y2="28" stroke="white" stroke-dasharray="9 10" />'
		+ '<line y1="13" x1="0" y2="13" x2="28" stroke="white" stroke-dasharray="9 10" />'
		+ '<line y1="14" x1="0" y2="14" x2="28" stroke="black" stroke-dasharray="9 10" />'
		+ '<line y1="15" x1="0" y2="15" x2="28" stroke="white" stroke-dasharray="9 10" />'
		+ '</svg>';
	return L.divIcon(o);
}
function officeIcon()
{
	var fill = 'cyan';
	var stroke = 'blue';

	var o = {iconSize: [26, 20], className: 'officeIcon', popupAnchor: [0, -4]};
	o.html = '<svg xmlns="http://www.w3.org/2000/svg" width="26" height="20" viewBox="0 0 26 20">'
		+ '<path fill="' + fill + '" stroke="' + stroke + '" stroke-width="2" '
		+ 'd="M 13,1 L 1,10 3,10 3,19 11,19 11,10 15,10 15,19 23,19 23,10 25,10 Z" /></svg>';
	return L.divIcon(o);
}
function loadJSON(url, onSuccess, onFailure)
{
	var xhr = new XMLHttpRequest();

	xhr.responseType = 'json';
	xhr.onreadystatechange = function() {
		if (xhr.readyState === 4)
			if (xhr.status === 200)
				onSuccess(xhr.response);
			else if (onFailure)
				onFailure();
	}

	xhr.open('GET', url);
	xhr.send();
}
function createMap(options)
{
	var queryString = {
		baseLayer: 'Outdoors',
		overlays: [],
	};
	parseQueryString(queryString);

	var layers = [
		'Outdoors',
		'Run Bike Hike',
		'Satellite',
		'Streets Satellite',
		'Streets',
		'Pencil',
		'Emerald',
	];

	var baseLayers = {};
	for (var layer of layers)
	{
		var id = 'mapbox.' + layer.toLowerCase().replace(/ /g, '-');
		baseLayers[layer] = L.mapbox.tileLayer(id, options);
	}

	var map = L.mapbox.map('map');
	baseLayers[queryString.baseLayer].addTo(map);
	var layersControl = L.control.layers(baseLayers).addTo(map);
	L.control.scale().addTo(map);

	var mapBounds = [[42, -114.1], [32.5, -124.4]]; // California
	var mapBoundsFromOverlay = false;
	var overlaysToLoad = queryString.overlays.length;

	if (queryString.ll) {
		var minZoom = map.getMinZoom();
		var maxZoom = map.getMaxZoom();

		var zoom = queryString.zoom || (maxZoom - 5);

		if (zoom < minZoom) zoom = minZoom; else
		if (zoom > maxZoom) zoom = maxZoom;

		map.setView(queryString.ll, zoom);
	} else
		map.fitBounds(mapBounds);

	document.getElementById('fitLink').addEventListener('click',
		function() { map.fitBounds(mapBounds); }, false);

	var llText = document.getElementById('llText').firstChild;
	function updateCenter()
	{
		var center = map.getCenter();
		llText.nodeValue = center.lat.toFixed(6) + ',' + center.lng.toFixed(6);
		return center;
	}

	var centerMarker = L.marker(updateCenter(), {
		keyboard: false,
		interactive: false,
		zIndexOffset: 1000,
		icon: centerIcon()
	}).addTo(map);

	map.on('move', function() {
		centerMarker.setLatLng(updateCenter());
	});

	var layerOrder = ['blm_ca_aa', 'blm_ca_sa'];
	var layerGroup = {};
	for (var layerName of layerOrder)
		layerGroup[layerName] = [];

	function removeAddLayerGroup(layerName)
	{
		for (var layer of layerGroup[layerName])
			layer.remove().addTo(map);
	}

	var htmlFilename;

	function addPeak(feature, latlng)
	{
		var p = feature.properties;
		return L.marker(latlng, {icon: peakIcon(p)})
			.bindPopup(popupHtml(latlng, p, htmlFilename))
			.on('popupopen', enableTooltips)
			.on('dblclick', function() {
				map.setView(latlng, map.getMaxZoom() - 5);
			});
	}
	function addPeakOverlay(geojson)
	{
		var name = geojson.name;
		delete geojson.name;

		var id = geojson.id;
		delete geojson.id;

		htmlFilename = id.toLowerCase() + '.html#' + id;

		var overlay = L.geoJSON(geojson, {pointToLayer: addPeak}).addTo(map);
		layersControl.addOverlay(overlay, name);

		if (mapBoundsFromOverlay) {
			mapBounds.extend(overlay.getBounds());
		} else {
			mapBounds = overlay.getBounds();
			mapBoundsFromOverlay = true;
		}
		if (--overlaysToLoad === 0 && !queryString.ll)
			map.fitBounds(mapBounds);
	}
	var styleBLM = {
		'Northern California District': {
			color: '#4169E1', // RoyalBlue
		},
		'Central California District': {
			color: '#1E90FF', // DodgerBlue
		},
		'California Desert District': {
			color: '#00BFFF', // DeepSkyBlue
		},
	};
	function getBLM_AA_Style(feature)
	{
		return styleBLM[feature.properties.parent] || {};
	}
	function addBLM_AA_Popup(feature, layer)
	{
		var name = 'BLM ' + feature.properties.name.slice(0, -13); // strip trailing " Field Office"
		var parent = feature.properties.parent;
		var html = '<div class="popupDiv blmPopup"><b>' + name + '</b><br>(' + parent + ')</div>';
		layer.bindPopup(html);
		layersControl.addOverlay(layer, name);
	}
	function addBLM_AA(geojson)
	{
		L.geoJSON(geojson, {onEachFeature: addBLM_AA_Popup, style: getBLM_AA_Style}).addTo(map);
		removeAddLayerGroup('blm_ca_sa');
	}
	function addBLM_FO_Popup(feature, latlng)
	{
		var name = 'BLM ' + feature.properties.name;
		var html = '<div class="popupDiv blmPopup"><b>' + name + '</b></div>';
		return L.marker(latlng, {icon: officeIcon()})
			.bindPopup(html, {maxWidth: 600})
			.on('dblclick', function() {
				map.setView(latlng, map.getMaxZoom() - 5);
			});
	}
	function addBLM_FO(geojson)
	{
		var layer = L.geoJSON(geojson, {pointToLayer: addBLM_FO_Popup}).addTo(map);
		layersControl.addOverlay(layer, 'BLM CA Offices');
	}
	function getBLM_SA_Style(feature)
	{
		return styleBLM[feature.properties.name] || {color: '#00008B'};
	}
	function addBLM_SA_Popup(feature, layer)
	{
		var name = 'BLM ' + feature.properties.name;
		var html = '<div class="popupDiv blmPopup"><b>'
			+ makeLink(BLM_CA_NLCS_Prefix + feature.properties.BLM, name) + ' ['
			+ makeLink(Wikipedia_Prefix + feature.properties.W, 'W')
			+ ']</b></div>';
		layer.bindPopup(html, {maxWidth: 600});
		layersControl.addOverlay(layer, name);
		layerGroup.blm_ca_sa.push(layer);
	}
	function addBLM_SA(geojson)
	{
		L.geoJSON(geojson, {onEachFeature: addBLM_SA_Popup, style: getBLM_SA_Style}).addTo(map);
	}
	var howToAddOverlay = {
		'blm_ca_aa.json': addBLM_AA,
		'blm_ca_fo.json': addBLM_FO,
		'blm_ca_sa.json': addBLM_SA,
		'dps.json': addPeakOverlay,
		'sps.json': addPeakOverlay,
	};

	for (var url of queryString.overlays)
	{
		var addOverlay = howToAddOverlay[url];
		if (addOverlay !== addPeakOverlay) --overlaysToLoad;
		loadJSON(url, addOverlay);
	}
}
function init()
{
	var protocol = window.location.protocol;
	var suffix = (protocol === 'file:' || protocol === '') ? 'json' : 'cgi';

	loadJSON('mapbox.' + suffix, createMap);
}
</script>
</head>
<body onload="init()">

<div id="map"></div>
<div id="llDiv"><span id="llText">Latitude, Longitude</span>
<span id="fitLink">&#9634;</span></div>

</body>
</html>
